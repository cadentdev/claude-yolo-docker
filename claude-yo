#!/bin/bash

# Parse arguments
REBUILD=false
for arg in "$@"; do
  case $arg in
    -h|--help)
      echo "Usage: claude-yo [OPTIONS]"
      echo ""
      echo "Run Claude Code in an isolated Docker container with YOLO mode enabled."
      echo ""
      echo "Options:"
      echo "  -r, --rebuild    Force rebuild of Docker image from scratch (clears cache)"
      echo "  -h, --help       Display this help message"
      echo ""
      echo "The container will mount your current directory as the workspace."
      echo "Authentication data persists across runs in a Docker volume."
      exit 0
      ;;
    -r|--rebuild)
      REBUILD=true
      shift
      ;;
    *)
      echo "Unknown option: $arg"
      echo "Use --help for usage information"
      exit 1
      ;;
  esac
done

# Get host user info
USERID=$(id -u)
GROUPID=$(id -g)
USERNAME=$(whoami)
MOUNTDIR=$(pwd)
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"

# Handle rebuild or normal build
if [ "$REBUILD" = true ]; then
  echo "Removing existing image..."
  docker rmi claude-yolo:latest 2>/dev/null || true
  echo "Building image from scratch (no cache)..."
  if ! docker build --no-cache -t claude-yolo:latest "$SCRIPT_DIR"; then
    echo "Error: Docker build failed. Please check the error messages above."
    exit 1
  fi
  echo "Build complete!"
elif [[ "$(docker images -q claude-yolo:latest 2> /dev/null)" == "" ]]; then
  echo "Building Docker image (first run only)..."
  if ! docker build -t claude-yolo:latest "$SCRIPT_DIR"; then
    echo "Error: Docker build failed. Please check the error messages above."
    exit 1
  fi
  echo "Build complete!"
fi

# Run the container
docker run \
  -v "$MOUNTDIR":/workspace \
  -v claude-yolo-home:/home-persist \
  -it \
  --rm \
  claude-yolo:latest \
  /bin/bash -c "
    # Find if a user with our UID already exists
    EXISTING_USER=\$(getent passwd $USERID | cut -d: -f1)
    
    if [ -n \"\$EXISTING_USER\" ]; then
      CONTAINER_USER=\$EXISTING_USER
    else
      CONTAINER_USER=$USERNAME
      groupadd -g $GROUPID \$CONTAINER_USER 2>/dev/null || true
      useradd -u $USERID -g $GROUPID -m -s /bin/bash \$CONTAINER_USER
    fi
    
    # Restore home directory from persistent volume if it exists
    if [ -d /home-persist/\$CONTAINER_USER ]; then
      cp -a /home-persist/\$CONTAINER_USER/. /home/\$CONTAINER_USER/
    fi

    # Display setup information
    echo \"═══════════════════════════════════════════════════════════════\"
    echo \"Container Setup Complete\"
    echo \"═══════════════════════════════════════════════════════════════\"
    echo \"Container user:      \$CONTAINER_USER\"
    echo \"UID:GID:             $USERID:$GROUPID\"
    echo \"Working directory:   $MOUNTDIR\"
    echo \"                     → mounted at /workspace\"
    echo \"═══════════════════════════════════════════════════════════════\"
    echo \"\"
    echo \"Press Enter to start Claude Code with --dangerously-skip-permissions\"
    read

    # Run claude as the determined user, then drop to shell for debugging
    su - \$CONTAINER_USER -c '
      cd /workspace
      claude --dangerously-skip-permissions
      echo \"\"
      echo \"═══════════════════════════════════════════════════════════════\"
      echo \"Claude exited. You are still in the container for debugging.\"
      echo \"Type exit to leave the container.\"
      echo \"═══════════════════════════════════════════════════════════════\"
      exec bash -i
    '
    
    # Save home directory to persistent volume (runs as root after shell exits)
    mkdir -p /home-persist/\$CONTAINER_USER
    cp -a /home/\$CONTAINER_USER/. /home-persist/\$CONTAINER_USER/
  "
